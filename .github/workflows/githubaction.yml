# .github/workflows/demo_workflow.yml
name: Demo CI-Pipeline

###############################################################################
# 1. ãƒˆãƒªã‚¬ãƒ¼å®šç¾©
###############################################################################
on:
  push:
    branches: [main]
    paths-ignore: ['README.md']
  pull_request:
  workflow_dispatch:           # æ‰‹å‹•èµ·å‹•
  schedule:                    # æ¯é€±æœˆæ›œ 03:00 (UTC)
    - cron: '0 3 * * MON'

###############################################################################
# 2. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…±é€šè¨­å®š
###############################################################################
concurrency:                   # ãƒ–ãƒ©ãƒ³ãƒã”ã¨ã«åŒæ™‚å®Ÿè¡Œã‚’ 1 ã¤ã«
  group: demo-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

###############################################################################
# 3. ã‚¸ãƒ§ãƒ–å®šç¾©
###############################################################################
jobs:
  #--------------------------------------------------------------------------#
  # 3-1. Lint ã‚¸ãƒ§ãƒ–
  #--------------------------------------------------------------------------#
  lint:
    name: ğŸ” Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Pretend Lint
        run: echo "Lint OK!"

  #--------------------------------------------------------------------------#
  # 3-2. Unit Testï¼ˆPython Ã— 3 ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒãƒˆãƒªã‚¯ã‚¹ï¼‰
  #--------------------------------------------------------------------------#
  unit-test:
    name: ğŸ§ª Unit Test (Py ${{ matrix.py }})
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        py: ['3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: {python-version: ${{ matrix.py }}}

      # ------- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¾‹ï¼ˆå®Ÿéš›ã¯ç©ºã ã‘ã©é›°å›²æ°—ï¼‰ -------
      - name: Cache â€œdepsâ€
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: deps-${{ runner.os }}-${{ matrix.py }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: deps-${{ runner.os }}-${{ matrix.py }}-

      - name: Run fake tests
        run: |
          echo "::group::pytest"
          echo "â€¦ã“ã“ã§ pytest ãŒé€šã‚‹æƒ³å®šâ€¦"
          echo "::endgroup::"

      - name: Upload dummy coverage
        uses: actions/upload-artifact@v4
        with:
          name: cov-${{ matrix.py }}
          path: <(printf 'coverage: 100%%\n')   # å³å¸­ãƒ•ã‚¡ã‚¤ãƒ«

  #--------------------------------------------------------------------------#
  # 3-3. Integration Test
  #--------------------------------------------------------------------------#
  integration-test:
    name: ğŸŒ Integration Test
    needs: unit-test
    runs-on: ubuntu-latest
    steps:
      - name: Spin up mock service
        run: echo "Start mock service"
      - name: Run integration scenario
        run: echo "All integrations green ğŸ‰"

  #--------------------------------------------------------------------------#
  # 3-4. Docs Buildï¼ˆä¸¦åˆ—ã§å®Ÿè¡Œï¼‰
  #--------------------------------------------------------------------------#
  docs-build:
    name: ğŸ“š Docs Build
    needs: lint
    runs-on: ubuntu-latest
    environment: docs-preview          # â€œç’°å¢ƒâ€ ã®ã‚µãƒ³ãƒ—ãƒ«
    steps:
      - uses: actions/checkout@v4
      - name: Build dummy docs
        run: |
          mkdir site
          echo '<h1>Docs</h1>' > site/index.html
      - uses: actions/upload-artifact@v4
        with:
          name: site
          path: site

  #--------------------------------------------------------------------------#
  # 3-5. Packaging
  #--------------------------------------------------------------------------#
  package:
    name: ğŸ“¦ Package
    needs: [integration-test, docs-build]
    runs-on: ubuntu-latest
    steps:
      - name: Create package file
        run: |
          mkdir out
          echo "dummy binary" > out/app.bin
      - uses: actions/upload-artifact@v4
        with:
          name: app-package
          path: out

  #--------------------------------------------------------------------------#
  # 3-6. Releaseï¼ˆã‚¿ã‚° push ã ã‘å®Ÿè¡Œã€å®Ÿéš›ã¯ä½•ã‚‚ã—ãªã„ï¼‰
  #--------------------------------------------------------------------------#
  release:
    name: ğŸš€ Release (tag only)
    if: startsWith(github.ref, 'refs/tags/')
    needs: package
    runs-on: ubuntu-latest
    steps:
      - name: Announce
        run: echo "ğŸ‰ Would create a GitHub Release here"
